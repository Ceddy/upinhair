<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBlzfYzF61pvW82ud5oyOy7ihlgIifaMzU&sensor=false"></script>

<h1 class='header-title'>Suggested Stylists</h1>

<div class="customer-help">
  Upinhair uses a complex algorithm to determine the best stylists near you using a combination of your personal information and the ratings of stylists around your location.
</div>

<div id='map-canvas'></div>

<script>
  var geocoder;
  var map;
  function initialize() {
    geocoder = new google.maps.Geocoder();

    /* TODO: Change this area to the default of the user's location */
    var latlng = new google.maps.LatLng(43.67023,-79.38676);
    var mapOptions = {
      zoom: 13,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    
    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  }
  
  function codeAddress(addressIn, i) {
    var address = addressIn;
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);

        var image = "<%= asset_path('map_markers')%>" + "/number_" + (i+1) + ".png";
        var marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location,
            title: "Stylists near your area",
            icon: image
        });
      } else {
        alert('Geocode was not successful for the following reason: ' + status);
      }
    });
  }

  initialize();
  // google.maps.event.addDomListener(window, 'load', initialize);
</script>

<span id="map-result">Found <%= @stylists.count %> stylists in <%= current_user.location %></span>

<div id="map-result-list" class="clearfix">
  <script>var i = 0;</script>
  <% @stylists.each do |stylist| %>
  <div class='stylist-wrapper'>
    <div class='stylist-picture'>
      <img src=<%= stylist.user.pic %> />
    </div>
    <div class='stylist-result'>
      <div class='stylist-info'>
        <h3><%= stylist.user.name %></h3>
        <p><%= stylist.user.location %></p>

        <div id='stylist-stars'>
          <% (1..stylist.rating.to_i).each do |i| %>
            <i class="icon-star"></i>
          <% end %>
        </div>
      </div>
      <div class='stylist-controls'>
        <td><%= link_to 'Book It', {:controller=>"appointments", :action=>"new", :stylist => stylist.id}, :class=>'actions' %>
      </div>
    </div>
  </div>

  <script>codeAddress('<%= stylist.user.location %>', i)</script>
  <script>i += 1;</script>
  <% end %>
</div>